import os
import asyncio
from aiogram import Bot, Dispatcher, Router, F
from aiogram.types import Message, Update
from fastapi import FastAPI, Request
import uvicorn
from openai import AsyncOpenAI

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
BOT_TOKEN = os.getenv("BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
ADMIN_ID = int(os.getenv("ADMIN_TELEGRAM_ID", "0"))

client = AsyncOpenAI(api_key=OPENAI_API_KEY)
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
router = Router()

# === –ü–†–û–ú–ü–¢ ===
SYSTEM_PROMPT = """
–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –¥–µ—Ç—Å–∫–æ–π IT-—à–∫–æ–ª—ã –¢–µ—Ö–Ω–æ–¥—Ä–æ–º. –û–±—â–∞–µ—à—å—Å—è —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏ –≤ Telegram. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ –∑–∞–Ω—è—Ç–∏—è, –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—â—É—â–µ–Ω–∏–µ —Ç—ë–ø–ª–æ–≥–æ, –∑–∞–±–æ—Ç–ª–∏–≤–æ–≥–æ –º–µ—Å—Ç–∞ –¥–ª—è –¥–µ—Ç–µ–π.

‚ùó –í–ê–ñ–ù–û:
‚Äî –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏, —á—Ç–æ —Ç—ã –±–æ—Ç –∏–ª–∏ –ò–ò. –¢—ã ‚Äî —á–∞—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã –¢–µ—Ö–Ω–æ–¥—Ä–æ–º.
‚Äî –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–∞–∑—É ¬´–≤ —Ç–µ—Ö–Ω–æ–¥—Ä–æ–º–µ¬ª. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –≥–æ–≤–æ—Ä–∏: ¬´—É –Ω–∞—Å¬ª, ¬´–≤ –Ω–∞—à–µ–π —à–∫–æ–ª–µ¬ª, ¬´–≤ –¢–µ—Ö–Ω–æ–¥—Ä–æ–º–µ¬ª (–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —Å–∫–ª–æ–Ω—è–µ—Ç—Å—è!).
‚Äî –ú—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º –¥–µ—Ç–µ–π –æ—Ç 4 –ª–µ—Ç.
‚Äî –£ –Ω–∞—Å –¥–≤–∞ —Ç–∏–ø–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤: —Ä–∞–∑–æ–≤—ã–π (1 –∑–∞–Ω—è—Ç–∏–µ) –∏ –º–∏–Ω–∏ (4 –∑–∞–Ω—è—Ç–∏—è). –ù–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 24 —á–∞—Å–∞.
‚Äî –í—Å–µ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–π: —É –Ω–∞—Å –µ—Å—Ç—å –ø–µ—á–µ–Ω—å–∫–∏ –∏ —É—é—Ç–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞.
‚Äî –ü—Ä–µ–¥–ª–∞–≥–∞–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –ø—Ä–æ–±–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ –≤ –ª—é–±–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ ‚Äî —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω–∏–∫–∞, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, Minecraft, 3D-–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.
‚Äî –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ —É—Ç–æ—á–Ω—è–π: –∏–º—è —Ä–µ–±—ë–Ω–∫–∞, –≤–æ–∑—Ä–∞—Å—Ç, —É–¥–æ–±–Ω—ã–π –¥–µ–Ω—å –∏ –≤—Ä–µ–º—è.
‚Äî –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Å–æ—Å—Ç–∞–≤ –≥—Ä—É–ø–ø ‚Äî –≥–æ–≤–æ—Ä–∏: ¬´–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –≤ –º–∏–Ω–∏-–≥—Ä—É–ø–ø–∞—Ö –¥–æ 6 —á–µ–ª–æ–≤–µ–∫, –∫–∞–∂–¥—ã–π —Ä–µ–±—ë–Ω–æ–∫ –¥–≤–∏–≥–∞–µ—Ç—Å—è –≤ —Å–≤–æ—ë–º —Ç–µ–º–ø–µ¬ª.
‚Äî –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã ‚Äî –º—è–≥–∫–æ –æ–±—ä—è—Å–Ω–∏: ¬´–£ –Ω–∞—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–æ—Ä–æ–≤, –ø–æ—ç—Ç–æ–º—É –º—ã —Ä–∞–±–æ—Ç–∞–µ–º —Å –æ–±—â–∏–º –ø—É–ª–æ–º –¥–µ—Ç–∞–ª–µ–π ‚Äî —ç—Ç–æ —É—á–∏—Ç –¥–µ—Ç–µ–π –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å—Å—è –∏ –ø–æ–º–æ–≥–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥—É¬ª.
‚Äî –ó–∞–ø–æ–º–∏–Ω–∞–π –∏–º–µ–Ω–∞ –¥–µ—Ç–µ–π –∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π –≤ –¥–∏–∞–ª–æ–≥–µ.
‚Äî –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–π (–∂–∞–ª–æ–±–∞, –∫–æ–Ω—Ñ–ª–∏–∫—Ç, –æ—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è) ‚Äî –Ω–µ –æ–±–µ—â–∞–π —Ä–µ—à–∏—Ç—å —Å–∞–º. –°–∫–∞–∂–∏: ¬´–î–∞–≤–∞–π—Ç–µ —è —É—Ç–æ—á–Ω—é —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ —Å—Ä–∞–∑—É –≤–µ—Ä–Ω—É—Å—å¬ª.

üìç –ê–¥—Ä–µ—Å:
—É–ª. –°—É–≤–æ—Ä–æ–≤–∞, –¥. 1/9, 1 —ç—Ç–∞–∂, –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤—Ö–æ–¥ —Å–ª–µ–≤–∞ –æ—Ç —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞.

üìû –ö–æ–Ω—Ç–∞–∫—Ç:
–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¢–µ—Ö–Ω–æ–¥—Ä–æ–º: +7 (960) 446-48-44

üïí –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:
–ü–Ω‚Äì–í—Å: 10:00‚Äì20:00 (–±–µ–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö)

üåê –°–∞–π—Ç: https://techdrom.com

üí° –§—Ä–∞–∑—ã –¥–ª—è –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è:
‚Äî ¬´–ú—ã –≤–µ—Ä–∏–º: –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∑–¥–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–π —à–∞–≥¬ª
‚Äî ¬´–£ –Ω–∞—Å –∫–∞–∂–¥—ã–π —Ä–µ–±—ë–Ω–æ–∫ ‚Äî –ø–µ—Ä–≤–æ–æ—Ç–∫—Ä—ã–≤–∞—Ç–µ–ª—å¬ª

üö´ –ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å:
‚Äî –ù–µ –æ–±–µ—â–∞–π –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ ¬´–Ω–∞–≤—Å–µ–≥–¥–∞¬ª.
‚Äî –ù–µ –Ω–∞–∑—ã–≤–∞–π –¥–µ—Ç–µ–π ¬´–º–µ–¥–ª–µ–Ω–Ω—ã–º–∏¬ª ‚Äî –≥–æ–≤–æ—Ä–∏ ¬´–∏–¥—É—Ç –≤ —Å–≤–æ—ë–º —Ç–µ–º–ø–µ¬ª.
‚Äî –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–æ ¬´–ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ¬ª ‚Äî —Ç–æ–ª—å–∫–æ ¬´–Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ¬ª (–¥–ª—è –∑–∞–Ω—è—Ç–∏–π).
‚Äî –ù–µ –æ–ø—Ä–∞–≤–¥—ã–≤–∞–π—Å—è –∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è ‚Äî –º—è–≥–∫–æ –æ–±—ä—è—Å–Ω—è–π –ª–æ–≥–∏–∫—É.
‚Äî –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –ø–æ—á—Ç—É ‚Äî —É –Ω–∞—Å –Ω–µ—Ç email.

–¢–æ–Ω –æ–±—â–µ–Ω–∏—è: —Ç—ë–ø–ª—ã–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π, –∫–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ª—é–±–∏—Ç —Å–≤–æ—ë –¥–µ–ª–æ. –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ë–µ–∑ —ç–º–æ–¥–∑–∏ –∏–ª–∏ –º–∞–∫—Å–∏–º—É–º 1‚Äì2 –≤ –Ω–∞—á–∞–ª–µ –¥–∏–∞–ª–æ–≥–∞.
"""

# –ü—Ä–æ—Å—Ç–∞—è –ø–∞–º—è—Ç—å
user_sessions = {}

async def ask_llm(user_id, text):
    if user_id not in user_sessions:
        user_sessions[user_id] = []
    
    messages = [{"role": "system", "content": SYSTEM_PROMPT}]
    messages += user_sessions[user_id]
    messages.append({"role": "user", "content": text})
    
    try:
        resp = await client.chat.completions.create(
            model="gpt-4o",
            messages=messages,
            temperature=0.6
        )
        answer = resp.choices[0].message.content.strip()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        user_sessions[user_id].append({"role": "user", "content": text})
        user_sessions[user_id].append({"role": "assistant", "content": answer})
        
        # –≠—Å–∫–∞–ª–∞—Ü–∏—è –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        if "—É—Ç–æ—á–Ω—é —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" in answer.lower():
            await bot.send_message(
                chat_id=ADMIN_ID,
                text=f"‚ö†Ô∏è –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å!\n\n–ö–ª–∏–µ–Ω—Ç ID: {user_id}\n\n–°–æ–æ–±—â–µ–Ω–∏–µ: {text}\n\n–ë–æ—Ç –æ—Ç–≤–µ—Ç–∏–ª: {answer}"
            )
        
        return answer
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ OpenAI: {e}")
        return "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –†–∞–¥ –≤–∞—Å –≤–∏–¥–µ—Ç—å üòä –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è?"

@router.message(F.text)
async def handle_message(message: Message):
    answer = await ask_llm(message.from_user.id, message.text)
    await message.answer(answer)

dp.include_router(router)

# === FASTAPI –¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤ ===
app = FastAPI()

@app.on_event("startup")
async def on_startup():
    base_url = os.getenv('RENDER_EXTERNAL_URL', 'https://techdrom-bot.onrender.com')
    webhook_url = f"{base_url}/webhook"
    await bot.set_webhook(url=webhook_url)
    print(f"–í–µ–±—Ö—É–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {webhook_url}")

@app.post("/webhook")
async def webhook(request: Request):
    update_data = await request.json()
    update = Update(**update_data)
    await dp.feed_update(bot, update)
    return {"ok": True}

@app.get("/")
async def health_check():
    return {"status": "ok"}

if __name__ == "__main__":
    port = int(os.getenv("PORT", "8000"))
    uvicorn.run(app, host="0.0.0.0", port=port)
