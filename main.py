import os
import asyncio
from aiogram import Bot, Dispatcher, Router, F
from aiogram.types import Message, Update
from fastapi import FastAPI, Request
import uvicorn
import requests

BOT_TOKEN = os.getenv("BOT_TOKEN")
HF_API_KEY = os.getenv("HF_API_KEY")
ADMIN_ID = int(os.getenv("ADMIN_TELEGRAM_ID", "0"))

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
router = Router()

SYSTEM_PROMPT = """Ð¢Ñ‹ â€” Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð´ÐµÑ‚ÑÐºÐ¾Ð¹ IT-ÑˆÐºÐ¾Ð»Ñ‹ Ð¢ÐµÑ…Ð½Ð¾Ð´Ñ€Ð¾Ð¼. ÐžÐ±Ñ‰Ð°ÐµÑˆÑŒÑÑ Ñ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑÐ¼Ð¸ Ð² Telegram. Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° â€” Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°Ñ‚ÑŒÑÑ Ð½Ð° Ð·Ð°Ð½ÑÑ‚Ð¸Ñ, Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ñ‚ÑŒ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¸ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‰ÑƒÑ‰ÐµÐ½Ð¸Ðµ Ñ‚Ñ‘Ð¿Ð»Ð¾Ð³Ð¾, Ð·Ð°Ð±Ð¾Ñ‚Ð»Ð¸Ð²Ð¾Ð³Ð¾ Ð¼ÐµÑÑ‚Ð° Ð´Ð»Ñ Ð´ÐµÑ‚ÐµÐ¹.

â— Ð’ÐÐ–ÐÐž:
â€” ÐÐ¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ð³Ð¾Ð²Ð¾Ñ€Ð¸, Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð±Ð¾Ñ‚ Ð¸Ð»Ð¸ Ð˜Ð˜. Ð¢Ñ‹ â€” Ñ‡Ð°ÑÑ‚ÑŒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¢ÐµÑ…Ð½Ð¾Ð´Ñ€Ð¾Ð¼.
â€” ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ„Ñ€Ð°Ð·Ñƒ Â«Ð² Ñ‚ÐµÑ…Ð½Ð¾Ð´Ñ€Ð¾Ð¼ÐµÂ». Ð’Ð¼ÐµÑÑ‚Ð¾ ÑÑ‚Ð¾Ð³Ð¾ Ð³Ð¾Ð²Ð¾Ñ€Ð¸: Â«Ñƒ Ð½Ð°ÑÂ», Â«Ð² Ð½Ð°ÑˆÐµÐ¹ ÑˆÐºÐ¾Ð»ÐµÂ», Â«Ð² Ð¢ÐµÑ…Ð½Ð¾Ð´Ñ€Ð¾Ð¼ÐµÂ» (Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð½Ðµ ÑÐºÐ»Ð¾Ð½ÑÐµÑ‚ÑÑ!).
â€” ÐœÑ‹ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÐ¼ Ð´ÐµÑ‚ÐµÐ¹ Ð¾Ñ‚ 4 Ð»ÐµÑ‚.
â€” Ð£ Ð½Ð°Ñ Ð´Ð²Ð° Ñ‚Ð¸Ð¿Ð° Ð°Ð±Ð¾Ð½ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²: Ñ€Ð°Ð·Ð¾Ð²Ñ‹Ð¹ (1 Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ) Ð¸ Ð¼Ð¸Ð½Ð¸ (4 Ð·Ð°Ð½ÑÑ‚Ð¸Ñ). ÐÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ñ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ½ÐµÑÑ‚Ð¸ Ð¿Ñ€Ð¸ ÑƒÑÐ»Ð¾Ð²Ð¸Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð·Ð° 24 Ñ‡Ð°ÑÐ°.
â€” Ð’ÑÐµÐ³Ð´Ð° ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð¹: Ñƒ Ð½Ð°Ñ ÐµÑÑ‚ÑŒ Ð¿ÐµÑ‡ÐµÐ½ÑŒÐºÐ¸ Ð¸ ÑƒÑŽÑ‚Ð½Ð°Ñ Ð°Ñ‚Ð¼Ð¾ÑÑ„ÐµÑ€Ð°.
â€” ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾Ðµ Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð·Ð°Ð½ÑÑ‚Ð¸Ðµ Ð² Ð»ÑŽÐ±Ð¾Ð¼ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ â€” Ñ€Ð¾Ð±Ð¾Ñ‚Ð¾Ñ‚ÐµÑ…Ð½Ð¸ÐºÐ°, Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ, Minecraft, 3D-Ð¼Ð¾Ð´ÐµÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ.
â€” ÐŸÑ€Ð¸ Ð·Ð°Ð¿Ð¸ÑÐ¸ ÑƒÑ‚Ð¾Ñ‡Ð½ÑÐ¹: Ð¸Ð¼Ñ Ñ€ÐµÐ±Ñ‘Ð½ÐºÐ°, Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚, ÑƒÐ´Ð¾Ð±Ð½Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð¸ Ð²Ñ€ÐµÐ¼Ñ.
â€” Ð•ÑÐ»Ð¸ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÑŽÑ‚ Ð¿Ñ€Ð¾ ÑÐ¾ÑÑ‚Ð°Ð² Ð³Ñ€ÑƒÐ¿Ð¿ â€” Ð³Ð¾Ð²Ð¾Ñ€Ð¸: Â«ÐœÑ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼ Ð² Ð¼Ð¸Ð½Ð¸-Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ñ… Ð´Ð¾ 6 Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº, ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ€ÐµÐ±Ñ‘Ð½Ð¾Ðº Ð´Ð²Ð¸Ð³Ð°ÐµÑ‚ÑÑ Ð² ÑÐ²Ð¾Ñ‘Ð¼ Ñ‚ÐµÐ¼Ð¿ÐµÂ».
â€” Ð•ÑÐ»Ð¸ ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÑŽÑ‚ Ð¿Ñ€Ð¾ ÐºÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ‚Ð¾Ñ€Ñ‹ â€” Ð¼ÑÐ³ÐºÐ¾ Ð¾Ð±ÑŠÑÑÐ½Ð¸: Â«Ð£ Ð½Ð°Ñ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð½Ð°Ð±Ð¾Ñ€Ð¾Ð², Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð¼Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼ Ñ Ð¾Ð±Ñ‰Ð¸Ð¼ Ð¿ÑƒÐ»Ð¾Ð¼ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹ â€” ÑÑ‚Ð¾ ÑƒÑ‡Ð¸Ñ‚ Ð´ÐµÑ‚ÐµÐ¹ Ð´Ð¾Ð³Ð¾Ð²Ð°Ñ€Ð¸Ð²Ð°Ñ‚ÑŒÑÑ Ð¸ Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³ Ð´Ñ€ÑƒÐ³ÑƒÂ».
â€” Ð—Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð¹ Ð¸Ð¼ÐµÐ½Ð° Ð´ÐµÑ‚ÐµÐ¹ Ð¸ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÐµÐ¹ Ð² Ð´Ð¸Ð°Ð»Ð¾Ð³Ðµ.
â€” Ð•ÑÐ»Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾Ñ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ð¹ (Ð¶Ð°Ð»Ð¾Ð±Ð°, ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚, Ð¾ÑÐ¾Ð±Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ) â€” Ð½Ðµ Ð¾Ð±ÐµÑ‰Ð°Ð¹ Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ ÑÐ°Ð¼. Ð¡ÐºÐ°Ð¶Ð¸: Â«Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ñ ÑƒÑ‚Ð¾Ñ‡Ð½ÑŽ Ñƒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¸ ÑÑ€Ð°Ð·Ñƒ Ð²ÐµÑ€Ð½ÑƒÑÑŒÂ».

ðŸ“ ÐÐ´Ñ€ÐµÑ:
ÑƒÐ». Ð¡ÑƒÐ²Ð¾Ñ€Ð¾Ð²Ð°, Ð´. 1/9, 1 ÑÑ‚Ð°Ð¶, Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ…Ð¾Ð´ ÑÐ»ÐµÐ²Ð° Ð¾Ñ‚ Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ð¾Ð³Ð¾ Ñ†ÐµÐ½Ñ‚Ñ€Ð°.

ðŸ“ž ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚:
ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ Ð¢ÐµÑ…Ð½Ð¾Ð´Ñ€Ð¾Ð¼: +7 (960) 446-48-44

ðŸ•’ Ð§Ð°ÑÑ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹:
ÐŸÐ½â€“Ð’Ñ: 10:00â€“20:00 (Ð±ÐµÐ· Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ñ…)

ðŸŒ Ð¡Ð°Ð¹Ñ‚: https://techdrom.com

ðŸ’¡ Ð¤Ñ€Ð°Ð·Ñ‹ Ð´Ð»Ñ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²ÐµÐ½Ð¸Ñ:
â€” Â«ÐœÑ‹ Ð²ÐµÑ€Ð¸Ð¼: Ð½Ð¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ð¿Ð¾Ð·Ð´Ð½Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑˆÐ°Ð³Â»
â€” Â«Ð£ Ð½Ð°Ñ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ€ÐµÐ±Ñ‘Ð½Ð¾Ðº â€” Ð¿ÐµÑ€Ð²Ð¾Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°Ñ‚ÐµÐ»ÑŒÂ»

ðŸš« Ð§Ñ‚Ð¾ ÐÐ• Ð´ÐµÐ»Ð°Ñ‚ÑŒ:
â€” ÐÐµ Ð¾Ð±ÐµÑ‰Ð°Ð¹ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð³Ñ€Ð°Ñ„Ð¸Ðº Â«Ð½Ð°Ð²ÑÐµÐ³Ð´Ð°Â».
â€” ÐÐµ Ð½Ð°Ð·Ñ‹Ð²Ð°Ð¹ Ð´ÐµÑ‚ÐµÐ¹ Â«Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ð¼Ð¸Â» â€” Ð³Ð¾Ð²Ð¾Ñ€Ð¸ Â«Ð¸Ð´ÑƒÑ‚ Ð² ÑÐ²Ð¾Ñ‘Ð¼ Ñ‚ÐµÐ¼Ð¿ÐµÂ».
â€” ÐÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ»Ð¾Ð²Ð¾ Â«Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ð½Ñ‹ÐµÂ» â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Â«Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð½Ñ‹ÐµÂ» (Ð´Ð»Ñ Ð·Ð°Ð½ÑÑ‚Ð¸Ð¹).
â€” ÐÐµ Ð¾Ð¿Ñ€Ð°Ð²Ð´Ñ‹Ð²Ð°Ð¹ÑÑ Ð·Ð° Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ â€” Ð¼ÑÐ³ÐºÐ¾ Ð¾Ð±ÑŠÑÑÐ½ÑÐ¹ Ð»Ð¾Ð³Ð¸ÐºÑƒ.
â€” ÐÐµ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð½Ð° Ð¿Ð¾Ñ‡Ñ‚Ñƒ â€” Ñƒ Ð½Ð°Ñ Ð½ÐµÑ‚ email.

Ð¢Ð¾Ð½ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ: Ñ‚Ñ‘Ð¿Ð»Ñ‹Ð¹, Ð·Ð°Ð±Ð¾Ñ‚Ð»Ð¸Ð²Ñ‹Ð¹, ÐºÐ°Ðº ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸Ðº, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð»ÑŽÐ±Ð¸Ñ‚ ÑÐ²Ð¾Ñ‘ Ð´ÐµÐ»Ð¾. ÐšÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ. Ð‘ÐµÐ· ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð¸Ð»Ð¸ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 1â€“2 Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°."""

user_sessions = {}

async def ask_llm(user_id, text):
    if user_id not in user_sessions:
        user_sessions[user_id] = []
    
    messages = [{"role": "system", "content": SYSTEM_PROMPT}]
    for msg in user_sessions[user_id][-6:]:
        messages.append(msg)
    messages.append({"role": "user", "content": text})
    
    prompt = ""
    for msg in messages:
        role = "Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°" if msg["role"] == "system" else "Ð Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ" if msg["role"] == "user" else "Ð¢Ñ‹"
        prompt += f"{role}: {msg['content']}\n"
    prompt += "Ð¢Ñ‹:"

    try:
        response = requests.post(
            "https://api-inference.huggingface.co/models/Qwen/Qwen2.5-7B-Instruct",
            headers={
                "Authorization": f"Bearer {HF_API_KEY}",
                "Content-Type": "application/json"
            },
            json={
                "inputs": prompt,
                "parameters": {
                    "max_new_tokens": 250,
                    "temperature": 0.7,
                    "return_full_text": False
                }
            },
            timeout=45
        )
        
        if response.status_code == 200:
            result = response.json()
            if isinstance(result, list) and len(result) > 0:
                answer = result[0].get("generated_text", "").strip()
            else:
                answer = str(result).strip()
            
            if not answer or len(answer) < 5:
                answer = "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! Ð Ð°Ð´ Ð²Ð°Ñ Ð²Ð¸Ð´ÐµÑ‚ÑŒ ðŸ˜Š Ð§ÐµÐ¼ Ð¼Ð¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ ÑÐµÐ³Ð¾Ð´Ð½Ñ?"
            
            user_sessions[user_id].append({"role": "user", "content": text})
            user_sessions[user_id].append({"role": "assistant", "content": answer})
            
            if "ÑƒÑ‚Ð¾Ñ‡Ð½ÑŽ Ñƒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°" in answer.lower() or "ÑÐ¿Ñ€Ð¾ÑˆÑƒ Ñƒ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°" in answer.lower():
                await bot.send_message(
                    chat_id=ADMIN_ID,
                    text=f"âš ï¸ ÐÑƒÐ¶Ð½Ð° Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ!\n\nÐšÐ»Ð¸ÐµÐ½Ñ‚ ID: {user_id}\n\nÐ¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ: {text}\n\nÐ‘Ð¾Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð»: {answer}"
                )
            
            return answer
        else:
            return "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! Ð Ð°Ð´ Ð²Ð°Ñ Ð²Ð¸Ð´ÐµÑ‚ÑŒ ðŸ˜Š Ð§ÐµÐ¼ Ð¼Ð¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ ÑÐµÐ³Ð¾Ð´Ð½Ñ?"
            
    except Exception as e:
        return "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! Ð Ð°Ð´ Ð²Ð°Ñ Ð²Ð¸Ð´ÐµÑ‚ÑŒ ðŸ˜Š Ð§ÐµÐ¼ Ð¼Ð¾Ð³Ñƒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ ÑÐµÐ³Ð¾Ð´Ð½Ñ?"

@router.message(F.text)
async def handle_message(message: Message):
    answer = await ask_llm(message.from_user.id, message.text)
    await message.answer(answer)

dp.include_router(router)

app = FastAPI()

@app.on_event("startup")
async def on_startup():
    base_url = os.getenv('RENDER_EXTERNAL_URL', 'https://techdrom-bot.onrender.com')
    webhook_url = f"{base_url}/webhook"
    await bot.set_webhook(url=webhook_url)

@app.post("/webhook")
async def webhook(request: Request):
    update_data = await request.json()
    update = Update(**update_data)
    await dp.feed_update(bot, update)
    return {"ok": True}

@app.get("/")
async def health_check():
    return {"status": "ok"}

if __name__ == "__main__":
    port = int(os.getenv("PORT", "8000"))
    uvicorn.run(app, host="0.0.0.0", port=port)
